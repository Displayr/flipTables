context("TidyTools")

dat <- structure(c(1.13154172560113, 0.99009900990099, 0.282885431400283,
    0.565770862800566, 1.6973125884017, 2.12164073550212, 1.13154172560113,
    2.54596888260255, 1.83875530410184, 12.3055162659123, 0, 0.99009900990099,
    0.707213578500707, 0.848656294200849, 0.565770862800566, 0.707213578500707,
    3.96039603960396, 1.27298444130127, 2.54596888260255, 11.5983026874116,
    0, 0.848656294200849, 0.707213578500707, 1.41442715700141, 0.848656294200849,
    0, 1.6973125884017, 2.97029702970297, 1.98019801980198, 10.4667609618105,
    0.282885431400283, 0.424328147100424, 1.83875530410184, 0.565770862800566,
    0.99009900990099, 0.848656294200849, 2.68741159830269, 1.83875530410184,
    1.83875530410184, 11.3154172560113, 0, 0.848656294200849, 0.424328147100424,
    0.848656294200849, 0.424328147100424, 1.83875530410184, 0.99009900990099,
    1.41442715700141, 4.52616690240453, 11.3154172560113, 0, 0, 0.565770862800566,
    1.13154172560113, 0.848656294200849, 0.424328147100424, 0.424328147100424,
    2.26308345120226, 1.98019801980198, 7.63790664780764, 0, 0.848656294200849,
    0.282885431400283, 0.848656294200849, 1.27298444130127, 0.99009900990099,
    2.26308345120226, 1.98019801980198, 3.67751060820368, 12.1640735502122,
    1.55586987270156, 0.848656294200849, 1.41442715700141, 2.12164073550212,
    2.68741159830269, 2.26308345120226, 1.41442715700141, 0.848656294200849,
    3.67751060820368, 16.8316831683168, 0.282885431400283, 0, 0,
    0, 0.99009900990099, 1.6973125884017, 0, 3.11173974540311, 0.282885431400283,
    6.36492220650637, 3.25318246110325, 5.7991513437058, 6.22347949080622,
    8.34512022630834, 10.3253182461103, 10.8910891089109, 14.5685997171146,
    18.2461103253182, 22.3479490806223, 100),
.Dim = c(10L, 10L), statistic = "Total %", .Dimnames = list(
c("Less than $15,000", "$200,001 or more", "$150,001 to $200,000",
"$120,001 to $150,000", "$30,001 to $45,000", "$15,001 to $30,000",
"$90,001 to $120,000", "$45,001 to $60,000", "$60,001 to $90,000",
"NET"), c("18 to 24", "25 to 29", "30 to 34", "35 to 39",
"40 to 44", "45 to 49", "50 to 54", "55 to 64", "65 or more",
"NET")), name = "Income by Age", questions = c("Income", "Age"))

# This is QTable with the Base n statistic
# Note that 'Statistics - Right' and 'Statistics - Below' are never passed
# to the R output
tabWithN <- structure(c(12.2448979591837, 6.12244897959184, 4.08163265306122,
6.12244897959184, 4.08163265306122, 8.16326530612245, 22.4489795918367,
19.3877551020408, 17.3469387755102, 100, 32.2033898305085, 13.5593220338983,
5.08474576271187, 10.1694915254237, 5.08474576271187, 0, 5.08474576271187,
13.5593220338983, 15.2542372881356, 100, 11.8811881188119, 12.8712871287129,
12.8712871287129, 13.3663366336634, 8.41584158415842, 13.3663366336634,
13.3663366336634, 8.91089108910891, 4.95049504950495, 100, 10.8843537414966,
17.687074829932, 11.5646258503401, 7.48299319727891, 16.3265306122449,
3.40136054421769, 6.12244897959184, 22.4489795918367, 4.08163265306122,
100, 12.5, 6.25, 18.75, 6.25, 9.375, 12.5, 18.75, 15.625, 0,
100, 3.57142857142857, 19.6428571428571, 8.92857142857143, 16.0714285714286,
26.7857142857143, 5.35714285714286, 10.7142857142857, 8.92857142857143,
0, 100, 13.0769230769231, 2.30769230769231, 12.3076923076923,
20, 13.8461538461538, 6.92307692307692, 11.5384615384615, 12.3076923076923,
7.69230769230769, 100, 6.57894736842105, 15.7894736842105, 7.89473684210526,
5.26315789473684, 11.8421052631579, 9.21052631578947, 9.21052631578947,
28.9473684210526, 5.26315789473684, 100, 98, 98, 98, 98, 98,
98, 98, 98, 98, 98, 59, 59, 59, 59, 59, 59, 59, 59, 59, 59, 202,
202, 202, 202, 202, 202, 202, 202, 202, 202, 147, 147, 147, 147,
147, 147, 147, 147, 147, 147, 32, 32, 32, 32, 32, 32, 32, 32,
32, 32, 56, 56, 56, 56, 56, 56, 56, 56, 56, 56, 130, 130, 130,
130, 130, 130, 130, 130, 130, 130, 76, 76, 76, 76, 76, 76, 76,
76, 76, 76, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800, 800,
800, 800, 800, 800, 800), .Dim = c(10L, 8L, 3L), .Dimnames = list(
    c("18 to 24", "25 to 29", "30 to 34", "35 to 39", "40 to 44",
    "45 to 49", "50 to 54", "55 to 64", "65 or more", "NET"),
    c("Every or nearly every day", "4 to 5 days a week", "2 to 3 days a week",
    "Once a week", "Once every 2 weeks", "Once a month", "Less than once a month",
    "Never"), c("Column %", "Column n", "Base n")), name = "Age by Exercise frequency",         questions = c("Age", "Exercise frequency"))

set.seed(1234)
array1d <- table(rpois(20, 4))
attr(array1d, "statistic") <- "Count"

test_that("Select Rows",
{
    xx <- matrix(1:12, 3, 4, dimnames=list(LETTERS[1:3], letters[1:4]))
    x2 <- SelectRows(xx, "A,A,C")
    expect_equal(x2[1,], x2[2,])
    expect_warning(SelectRows(xx, "A,B,D,E,F"), "Table does not contain rows 'D','E','F'.")
    expect_warning(x3 <- SelectRows(xx, "D,E,F"), "Table does not contain rows 'D','E','F'.")
    expect_equal(nrow(x3), 0)
    x4 <- SelectRows(xx, "A,B,C,3,2,1")
    expect_warning(x5 <- SelectRows(xx, "A,B,C,3,2,1,0,7"), "Table does not contain rows '0','7'.")
    expect_equal(x5[,1], c(A=1,B=2,C=3,C=3,B=2,A=1))

    res <- SelectRows(tabWithN, NULL, NA, NA)
    expect_equal(tabWithN, res)

    res <- SelectRows(tabWithN, "18 to 24, 25 to 29, 3")
    expect_equal(dim(res), c(3, 8, 3))
    expect_equal(rownames(res), c("18 to 24", "25 to 29", "30 to 34"))

    res <- SelectRows(tabWithN, first.k = 4, "65 or more, NET")
    expect_equal(dim(res), c(6, 8, 3))
    expect_equal(rownames(res), c("18 to 24", "25 to 29", "30 to 34", "35 to 39", "65 or more", "NET"))

    res <- SelectRows(tabWithN, last.k = 3)
    expect_equal(dim(res), c(3, 8, 3))
})

test_that("Select Columns",
{
    res <- SelectColumns(tabWithN, "1, 2, Never")
    expect_equal(dim(res), c(10, 3, 3))
    expect_equal(colnames(res), c("Every or nearly every day", "4 to 5 days a week", "Never"))
    res <- SelectColumns(dat, last.k = 4)
    expect_equal(colnames(res), c("50 to 54", "55 to 64", "65 or more", "NET"))
    expect_equal(attr(res, "statistic"), "Total %")
})

test_that("Sort Rows",
{
    res <- SortRows(dat, decreasing = TRUE)
    expect_equal(dim(res), c(10, 10))
    expect_equal(rownames(res), rownames(dat)[c(9:1,10)])

    res <- SortRows(tabWithN)
    rownames(res) <- c("65 or more", "40 to 44", "55 to 64", "18 to 24", "25 to 29",
                       "30 to 34", "35 to 39", "45 to 49", "50 to 54", "NET")
})

test_that("Reverse rows and columns",
{
    res <- ReverseRows(array1d)
    expect_equal(rownames(res), rev(names(array1d)))
    expect_equal(attr(res, "statistic"), attr(array1d, "statistic"))

    res <- ReverseColumns(tabWithN)
    expect_equal(dim(res), dim(tabWithN))
    expect_equal(colnames(res), rev(colnames(tabWithN)))
    expect_equal(dimnames(res)[[3]], dimnames(tabWithN)[[3]])
})


test_that("Checking for small sample sizes",
{
    expect_silent(HideOutputsWithSmallSampleSizes(tabWithN, 30))
    expect_error(HideOutputsWithSmallSampleSizes(tabWithN, 1000))

    expect_silent(HideRowsAndColumnsWithSmallSampleSizes(tabWithN, 30))
    expect_warning(HideRowsAndColumnsWithSmallSampleSizes(tabWithN, 100),
                   "Columns 1,2,5,6,8 have sample size less than 100 and have been removed")
})

test_that("Automatic order rows/column by CA",
{
    dat <- structure(c(17.6551724137931, 13.6551724137931, 20.2758620689655,
                34.2068965517241, 16.551724137931, 78.3448275862069, 13.9310344827586,
                20.6896551724138, 94.7586206896552, 23.3103448275862, 22.2068965517241,
                37.9310344827586, 37.5172413793103, 25.9310344827586, 45.2413793103448,
                19.7241379310345, 23.8620689655172, 95.448275862069, 16.9655172413793,
                10.2068965517241, 12.2758620689655, 41.7931034482759, 27.7241379310345,
                27.0344827586207, 32.2758620689655, 43.1724137931034, 95.1724137931034,
                17.7931034482759, 11.5862068965517, 20.8275862068966, 37.6551724137931,
                38.2068965517241, 13.9310344827586, 36, 34.7586206896552, 98.7586206896552,
                11.3103448275862, 9.79310344827586, 11.1724137931034, 32.9655172413793,
                36, 20.9655172413793, 36.8275862068965, 51.8620689655172, 96.4137931034483,
                34.2068965517241, 29.1034482758621, 39.448275862069, 26.3448275862069,
                25.5172413793103, 51.1724137931034, 20.8275862068966, 19.1724137931034,
                97.7931034482759, 9.51724137931034, 6.20689655172414, 5.93103448275862,
                47.448275862069, 11.8620689655172, 63.8620689655172, 9.24137931034483,
                45.1034482758621, 98.2068965517241, 15.7241379310345, 35.7241379310345,
                88.2758620689655, 3.58620689655172, 13.5172413793103, 1.93103448275862,
                14.2068965517241, 3.17241379310345, 99.0344827586207, 3.72413793103448,
                2.06896551724138, 2.48275862068966, 35.448275862069, 6.89655172413793,
                71.8620689655172, 4.13793103448276, 43.3103448275862, 98.3448275862069,
                32.9655172413793, 33.2413793103448, 46.4827586206897, 52.1379310344828,
                33.9310344827586, 34.2068965517241, 30.4827586206897, 33.9310344827586,
                97.6551724137931, 10.4827586206897, 9.24137931034483, 9.51724137931034,
                44, 21.5172413793103, 39.1724137931035, 15.1724137931034, 44.2758620689655,
                85.3793103448276, 4.55172413793103, 3.58620689655172, 3.72413793103448,
                62.8965517241379, 16, 60.8275862068966, 10.0689655172414, 53.6551724137931,
                95.7241379310345, 11.3103448275862, 7.72413793103448, 8.27586206896552,
                23.448275862069, 11.1724137931034, 69.5172413793103, 9.51724137931034,
                21.1034482758621, 91.0344827586207, 22.6206896551724, 32.1379310344828,
                65.3793103448276, 24.551724137931, 22.0689655172414, 19.3103448275862,
                18.2068965517241, 15.5862068965517, 95.8620689655172, 11.1724137931034,
                9.24137931034483, 10.2068965517241, 48.551724137931, 16.2758620689655,
                46.0689655172414, 12.551724137931, 42.6206896551724, 94.8965517241379,
                10.7586206896552, 8.27586206896552, 8.27586206896552, 44.6896551724138,
                20.4137931034483, 57.6551724137931, 12.1379310344828, 43.8620689655172,
                95.448275862069, 14.3448275862069, 12.2758620689655, 13.3793103448276,
                49.2413793103448, 25.6551724137931, 37.2413793103448, 23.1724137931034,
                50.0689655172414, 98.2068965517241, 37.6551724137931, 37.3793103448276,
                57.3793103448276, 40.2758620689655, 37.5172413793103, 49.7931034482759,
                33.3793103448276, 35.0344827586207, 94.7586206896552, 63.3103448275862,
                72, 24.2758620689655, 6.48275862068965, 28, 4.96551724137931,
                47.1724137931034, 11.3103448275862, 92.6896551724138, 93.6551724137931,
                93.3793103448276, 97.9310344827586, 98.2068965517241, 95.0344827586207,
                99.0344827586207, 94.4827586206897, 98.0689655172414, 99.0344827586207
                ), .Dim = c(9L, 20L), statistic = "%", .Dimnames = list(c("AAPT/Cellular One",
                "New Tel", "One-tel", "Optus", "Orange (Hutchison)", "Telstra (Mobile Net)",
                "Virgin Mobile", "Vodafone", "NET"), c("Bureaucratic", "Slow service",
                "Friendly", "Low prices", "Fashionable", "Unfashionable", "Reliable",
                "Here today, gone tomorrow", "Good coverage", "Network often down",
                "The best phones", "Conveniently located stores", "High prices",
                "Unreliable", "Meet all my communication needs", "Leaders in mobile phone technology",
                "I like them", "I hate them", "Don't know much about them", "NET"
                )), name = "q20", questions = c("q20", "SUMMARY"))
    expect_silent(resR <- AutoOrderRows(dat[-9,-20]))
    expect_silent(resC <- AutoOrderColumns(dat[-9,-20]))
    expect_equal(rownames(resR), c("One-tel", "New Tel", "AAPT/Cellular One", "Virgin Mobile",
        "Orange (Hutchison)", "Optus", "Vodafone", "Telstra (Mobile Net)"))
    expect_equal(colnames(resC), c("Here today, gone tomorrow", "Don't know much about them",
        "Unreliable", "I hate them", "Unfashionable", "Network often down",
        "Slow service", "Low prices", "Fashionable", "Friendly", "Bureaucratic",
        "I like them", "The best phones", "Meet all my communication needs",
        "High prices", "Leaders in mobile phone technology", "Reliable",
        "Conveniently located stores", "Good coverage"))
})





